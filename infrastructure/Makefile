ifeq ($(STAGE),)
    INCLUDE_ENV_FILE := .env
else
    INCLUDE_ENV_FILE := .env.$(STAGE)
endif

-include $(INCLUDE_ENV_FILE)
export

.EXPORT_ALL_VARIABLES:
DOCKER_BUILDKIT = 1

help:
	@make -qpRr | egrep -e '^[a-z].*:$$' | sed -e 's~:~~g' | sort

diff:
	cdk diff \
	-c DOMAIN=$(DOMAIN) \
	-c DEFAULT_DATABASE_NAME=$(DEFAULT_DATABASE_NAME) \
	-c DB_CLUSTER_MIN=$(DB_CLUSTER_MIN) \
	-c DB_CLUSTER_MAX=$(DB_CLUSTER_MAX) \
	-c SECRET_KEY_BASE=$(SECRET_KEY_BASE) \
	-c VAULT_ENC_KEY=$(VAULT_ENC_KEY) \
	-c API_JWT_SECRET=$(API_JWT_SECRET) \
	-c METRICS_JWT_SECRET=$(METRICS_JWT_SECRET) \
	-c API_PORT=$(API_PORT) \
	-c PROXY_PORT_SESSION=$(PROXY_PORT_SESSION) \
	-c PROXY_PORT_TRANSACTION=$(PROXY_PORT_TRANSACTION) \
	-c RELEASE_COOKIE=$(RELEASE_COOKIE) \
	-c FARGATE_TASK_DESIRED_COUNT=$(FARGATE_TASK_DESIRED_COUNT)
 
deploy:
	cdk deploy \
	-c DOMAIN=$(DOMAIN) \
	-c DEFAULT_DATABASE_NAME=$(DEFAULT_DATABASE_NAME) \
	-c DB_CLUSTER_MIN=$(DB_CLUSTER_MIN) \
	-c DB_CLUSTER_MAX=$(DB_CLUSTER_MAX) \
	-c SECRET_KEY_BASE=$(SECRET_KEY_BASE) \
	-c VAULT_ENC_KEY=$(VAULT_ENC_KEY) \
	-c API_JWT_SECRET=$(API_JWT_SECRET) \
	-c METRICS_JWT_SECRET=$(METRICS_JWT_SECRET) \
	-c API_PORT=$(API_PORT) \
	-c PROXY_PORT_SESSION=$(PROXY_PORT_SESSION) \
	-c PROXY_PORT_TRANSACTION=$(PROXY_PORT_TRANSACTION) \
	-c RELEASE_COOKIE=$(RELEASE_COOKIE) \
	-c FARGATE_TASK_DESIRED_COUNT=$(FARGATE_TASK_DESIRED_COUNT)

destroy:
	cdk destroy \
	-c DOMAIN=$(DOMAIN) \
	-c DEFAULT_DATABASE_NAME=$(DEFAULT_DATABASE_NAME) \
	-c DB_CLUSTER_MIN=$(DB_CLUSTER_MIN) \
	-c DB_CLUSTER_MAX=$(DB_CLUSTER_MAX) \
	-c SECRET_KEY_BASE=$(SECRET_KEY_BASE) \
	-c VAULT_ENC_KEY=$(VAULT_ENC_KEY) \
	-c API_JWT_SECRET=$(API_JWT_SECRET) \
	-c METRICS_JWT_SECRET=$(METRICS_JWT_SECRET) \
	-c API_PORT=$(API_PORT) \
	-c PROXY_PORT_SESSION=$(PROXY_PORT_SESSION) \
	-c PROXY_PORT_TRANSACTION=$(PROXY_PORT_TRANSACTION) \
	-c RELEASE_COOKIE=$(RELEASE_COOKIE) \
	-c FARGATE_TASK_DESIRED_COUNT=$(FARGATE_TASK_DESIRED_COUNT)

bootstrap:
	cdk bootstrap \
	-c DOMAIN=$(DOMAIN) \
	-c DEFAULT_DATABASE_NAME=$(DEFAULT_DATABASE_NAME) \
	-c DB_CLUSTER_MIN=$(DB_CLUSTER_MIN) \
	-c DB_CLUSTER_MAX=$(DB_CLUSTER_MAX) \
	-c SECRET_KEY_BASE=$(SECRET_KEY_BASE) \
	-c VAULT_ENC_KEY=$(VAULT_ENC_KEY) \
	-c API_JWT_SECRET=$(API_JWT_SECRET) \
	-c METRICS_JWT_SECRET=$(METRICS_JWT_SECRET) \
	-c API_PORT=$(API_PORT) \
	-c PROXY_PORT_SESSION=$(PROXY_PORT_SESSION) \
	-c PROXY_PORT_TRANSACTION=$(PROXY_PORT_TRANSACTION) \
	-c RELEASE_COOKIE=$(RELEASE_COOKIE) \
	-c FARGATE_TASK_DESIRED_COUNT=$(FARGATE_TASK_DESIRED_COUNT)